<script setup lang="ts">
import { ref } from 'vue'
import type { AddToCartLineItem } from '#shared/types'
import { useBigCommerceCart } from '~/composables/useBigCommerceCart'
import LoaderSpinner from '~/components/common/LoaderSpinner.vue'

interface Props {
  productId: number
  qty?: number
  inStock?: boolean
  variantId?: number
}

const props = withDefaults(defineProps<Props>(), {
  qty: 1,
  variantId: undefined,
})

const bigCommerceCart = useBigCommerceCart()

// this element key is needed to force re-render of the button
// when the user clicks the button to add to cart
// this is needed to forget the hovered state of the button
const elementKey = ref<string>(generateRandomUniqueKey())

async function handleAddToCartClick() {
  const lineItemDetails: AddToCartLineItem = {
    quantity: props.qty,
    productId: props.productId,
  }
  if (props.variantId) {
    lineItemDetails.variantId = props.variantId
  }

  try {
    await bigCommerceCart.addToCart(lineItemDetails)
    console.log('Added to cart!')
    elementKey.value = generateRandomUniqueKey()
  } catch (error) {
    console.error('Failed to add to cart:', error)
  }
}

function generateRandomUniqueKey() {
  return [
    'AddToCartButton',
    props.productId,
    props.variantId || '-',
    Date.now(),
  ].join('--')
}
</script>

<template>
  <div>
    <div v-if="!inStock" class="prose">
      <p class="font-bold">Out of stock</p>
    </div>
    <!-- <div v-else class="flex items-center gap-2 rounded-full bg-primary px-6 py-2 text-white transition hover:bg-blue-600">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M16.5454 11.0605L18.2998 5.22788C18.337 5.10388 18.3434 4.97337 18.3184 4.84663C18.2935 4.71988 18.238 4.60036 18.1562 4.49747C18.0744 4.39457 17.9686 4.31111 17.8471 4.25365C17.7255 4.1962 17.5917 4.16631 17.4559 4.16634H5.85082L5.3289 2.28741C5.27951 2.1095 5.16951 1.95212 5.01607 1.83983C4.86262 1.72754 4.67437 1.66665 4.48067 1.66666H2.54385C2.31121 1.66666 2.0881 1.75444 1.92359 1.9107C1.75909 2.06696 1.66667 2.2789 1.66667 2.49989C1.66667 2.72087 1.75909 2.93281 1.92359 3.08907C2.0881 3.24533 2.31121 3.33311 2.54385 3.33311H3.80524L4.33155 5.21205V5.22038V5.22788L6.08591 11.0605L6.74028 13.5485C6.30707 13.731 5.93377 14.0211 5.65979 14.3884C5.38581 14.7557 5.22133 15.1864 5.1837 15.6352C5.14608 16.0839 5.23671 16.5339 5.44603 16.9378C5.65535 17.3416 5.97558 17.6843 6.37292 17.9296C6.77027 18.1749 7.22996 18.3137 7.70348 18.3314C8.177 18.3491 8.64676 18.245 9.06316 18.0301C9.47956 17.8152 9.82715 17.4975 10.0692 17.1106C10.3113 16.7236 10.4389 16.2817 10.4385 15.8315C10.4356 15.5471 10.381 15.2652 10.2771 14.9983H12.3542C12.2503 15.2652 12.1957 15.5471 12.1928 15.8315C12.1928 16.3259 12.3472 16.8092 12.6363 17.2203C12.9255 17.6314 13.3365 17.9518 13.8173 18.141C14.2982 18.3302 14.8273 18.3797 15.3378 18.2832C15.8482 18.1868 16.3171 17.9487 16.6852 17.5991C17.0532 17.2495 17.3038 16.8041 17.4054 16.3192C17.5069 15.8343 17.4548 15.3317 17.2556 14.875C17.0564 14.4182 16.7191 14.0278 16.2864 13.7531C15.8536 13.4785 15.3448 13.3319 14.8244 13.3319H8.49114L8.05255 11.6654H15.7016C15.8923 11.6655 16.0779 11.6064 16.2302 11.4973C16.3825 11.3881 16.4931 11.2348 16.5454 11.0605ZM14.8244 14.9983C14.9979 14.9983 15.1675 15.0472 15.3117 15.1387C15.456 15.2303 15.5684 15.3604 15.6348 15.5127C15.7012 15.6649 15.7186 15.8325 15.6847 15.9941C15.6509 16.1557 15.5673 16.3042 15.4446 16.4207C15.322 16.5373 15.1657 16.6166 14.9955 16.6488C14.8254 16.6809 14.649 16.6644 14.4887 16.6014C14.3284 16.5383 14.1914 16.4315 14.095 16.2945C13.9986 16.1574 13.9472 15.9963 13.9472 15.8315C13.9472 15.6106 14.0396 15.3986 14.2041 15.2424C14.3686 15.0861 14.5917 14.9983 14.8244 14.9983ZM8.68412 15.8315C8.68412 15.9963 8.63267 16.1574 8.53628 16.2945C8.4399 16.4315 8.3029 16.5383 8.14262 16.6014C7.98233 16.6644 7.80596 16.6809 7.63581 16.6488C7.46565 16.6166 7.30935 16.5373 7.18668 16.4207C7.064 16.3042 6.98046 16.1557 6.94661 15.9941C6.91276 15.8325 6.93013 15.6649 6.99653 15.5127C7.06292 15.3604 7.17535 15.2303 7.3196 15.1387C7.46385 15.0472 7.63345 14.9983 7.80694 14.9983C8.03958 14.9983 8.26269 15.0861 8.4272 15.2424C8.5917 15.3986 8.68412 15.6106 8.68412 15.8315ZM13.07 8.33249H12.1928V9.16572C12.1928 9.3867 12.1004 9.59864 11.9359 9.7549C11.7714 9.91116 11.5483 9.99895 11.3157 9.99895C11.083 9.99895 10.8599 9.91116 10.6954 9.7549C10.5309 9.59864 10.4385 9.3867 10.4385 9.16572V8.33249H9.5613C9.32865 8.33249 9.10554 8.2447 8.94104 8.08844C8.77653 7.93218 8.68412 7.72025 8.68412 7.49926C8.68412 7.27827 8.77653 7.06634 8.94104 6.91008C9.10554 6.75382 9.32865 6.66603 9.5613 6.66603H10.4385V5.8328C10.4385 5.61182 10.5309 5.39988 10.6954 5.24362C10.8599 5.08736 11.083 4.99957 11.3157 4.99957C11.5483 4.99957 11.7714 5.08736 11.9359 5.24362C12.1004 5.39988 12.1928 5.61182 12.1928 5.8328V6.66603H13.07C13.3027 6.66603 13.5258 6.75382 13.6903 6.91008C13.8548 7.06634 13.9472 7.27827 13.9472 7.49926C13.9472 7.72025 13.8548 7.93218 13.6903 8.08844C13.5258 8.2447 13.3027 8.33249 13.07 8.33249Z" fill="white"/>
      </svg>
      Add to Cart
    </div> -->
    <div v-else class="flex w-full">
      <div
        :key="elementKey"
        class="group relative w-full cursor-pointer overflow-hidden rounded-full border border-primary transition-all duration-1000"
        @click.prevent="handleAddToCartClick"
      >
        <div
          class="flex h-[32px] w-full items-center justify-center bg-primary text-base tracking-wider"
        >
          <div
            v-if="bigCommerceCart.isLoading.value"
            class="flex w-full items-center justify-center space-x-2 bg-primary-dark px-10 text-white/50"
          >
            <LoaderSpinner color="light" />
            <span>Adding...</span>
          </div>
          <div
            v-else
            class="flex items-center justify-center gap-2 bg-primary px-6"
          >
            <span class="flex">
              <svg
                width="20"
                height="20"
                viewBox="0 0 20 20"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M16.5454 11.0605L18.2998 5.22788C18.337 5.10388 18.3434 4.97337 18.3184 4.84663C18.2935 4.71988 18.238 4.60036 18.1562 4.49747C18.0744 4.39457 17.9686 4.31111 17.8471 4.25365C17.7255 4.1962 17.5917 4.16631 17.4559 4.16634H5.85082L5.3289 2.28741C5.27951 2.1095 5.16951 1.95212 5.01607 1.83983C4.86262 1.72754 4.67437 1.66665 4.48067 1.66666H2.54385C2.31121 1.66666 2.0881 1.75444 1.92359 1.9107C1.75909 2.06696 1.66667 2.2789 1.66667 2.49989C1.66667 2.72087 1.75909 2.93281 1.92359 3.08907C2.0881 3.24533 2.31121 3.33311 2.54385 3.33311H3.80524L4.33155 5.21205V5.22038V5.22788L6.08591 11.0605L6.74028 13.5485C6.30707 13.731 5.93377 14.0211 5.65979 14.3884C5.38581 14.7557 5.22133 15.1864 5.1837 15.6352C5.14608 16.0839 5.23671 16.5339 5.44603 16.9378C5.65535 17.3416 5.97558 17.6843 6.37292 17.9296C6.77027 18.1749 7.22996 18.3137 7.70348 18.3314C8.177 18.3491 8.64676 18.245 9.06316 18.0301C9.47956 17.8152 9.82715 17.4975 10.0692 17.1106C10.3113 16.7236 10.4389 16.2817 10.4385 15.8315C10.4356 15.5471 10.381 15.2652 10.2771 14.9983H12.3542C12.2503 15.2652 12.1957 15.5471 12.1928 15.8315C12.1928 16.3259 12.3472 16.8092 12.6363 17.2203C12.9255 17.6314 13.3365 17.9518 13.8173 18.141C14.2982 18.3302 14.8273 18.3797 15.3378 18.2832C15.8482 18.1868 16.3171 17.9487 16.6852 17.5991C17.0532 17.2495 17.3038 16.8041 17.4054 16.3192C17.5069 15.8343 17.4548 15.3317 17.2556 14.875C17.0564 14.4182 16.7191 14.0278 16.2864 13.7531C15.8536 13.4785 15.3448 13.3319 14.8244 13.3319H8.49114L8.05255 11.6654H15.7016C15.8923 11.6655 16.0779 11.6064 16.2302 11.4973C16.3825 11.3881 16.4931 11.2348 16.5454 11.0605ZM14.8244 14.9983C14.9979 14.9983 15.1675 15.0472 15.3117 15.1387C15.456 15.2303 15.5684 15.3604 15.6348 15.5127C15.7012 15.6649 15.7186 15.8325 15.6847 15.9941C15.6509 16.1557 15.5673 16.3042 15.4446 16.4207C15.322 16.5373 15.1657 16.6166 14.9955 16.6488C14.8254 16.6809 14.649 16.6644 14.4887 16.6014C14.3284 16.5383 14.1914 16.4315 14.095 16.2945C13.9986 16.1574 13.9472 15.9963 13.9472 15.8315C13.9472 15.6106 14.0396 15.3986 14.2041 15.2424C14.3686 15.0861 14.5917 14.9983 14.8244 14.9983ZM8.68412 15.8315C8.68412 15.9963 8.63267 16.1574 8.53628 16.2945C8.4399 16.4315 8.3029 16.5383 8.14262 16.6014C7.98233 16.6644 7.80596 16.6809 7.63581 16.6488C7.46565 16.6166 7.30935 16.5373 7.18668 16.4207C7.064 16.3042 6.98046 16.1557 6.94661 15.9941C6.91276 15.8325 6.93013 15.6649 6.99653 15.5127C7.06292 15.3604 7.17535 15.2303 7.3196 15.1387C7.46385 15.0472 7.63345 14.9983 7.80694 14.9983C8.03958 14.9983 8.26269 15.0861 8.4272 15.2424C8.5917 15.3986 8.68412 15.6106 8.68412 15.8315ZM13.07 8.33249H12.1928V9.16572C12.1928 9.3867 12.1004 9.59864 11.9359 9.7549C11.7714 9.91116 11.5483 9.99895 11.3157 9.99895C11.083 9.99895 10.8599 9.91116 10.6954 9.7549C10.5309 9.59864 10.4385 9.3867 10.4385 9.16572V8.33249H9.5613C9.32865 8.33249 9.10554 8.2447 8.94104 8.08844C8.77653 7.93218 8.68412 7.72025 8.68412 7.49926C8.68412 7.27827 8.77653 7.06634 8.94104 6.91008C9.10554 6.75382 9.32865 6.66603 9.5613 6.66603H10.4385V5.8328C10.4385 5.61182 10.5309 5.39988 10.6954 5.24362C10.8599 5.08736 11.083 4.99957 11.3157 4.99957C11.5483 4.99957 11.7714 5.08736 11.9359 5.24362C12.1004 5.39988 12.1928 5.61182 12.1928 5.8328V6.66603H13.07C13.3027 6.66603 13.5258 6.75382 13.6903 6.91008C13.8548 7.06634 13.9472 7.27827 13.9472 7.49926C13.9472 7.72025 13.8548 7.93218 13.6903 8.08844C13.5258 8.2447 13.3027 8.33249 13.07 8.33249Z"
                  fill="white"
                />
              </svg>
            </span>
            <span
              class="flex justify-center text-[12px] font-semibold leading-[15.6px] tracking-normal text-white transition-all duration-1000 group-hover:text-white"
            >
              Add to Cart
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<style lang="scss" scoped>
//button {
//  // @apply disabled:!bg-primary/80;
//  @apply disabled:bg-primary/80;
//}
</style>
